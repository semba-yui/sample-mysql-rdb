# CONTRIBUTING GUIDE

## 目次

- [コード規約](#コード規約)
  - [SQLファイル](#sqlファイル)
  - [Markdownドキュメント](#markdownドキュメント)
- [Flyway](#flyway)
  - [Versioned Migration の命名フォーマット](#versioned-migration-の命名フォーマット)
  - [Repeatable Migration の命名フォーマット](#repeatable-migration-の命名フォーマット)
  - [マイグレーションの実行方法](#マイグレーションの実行方法)
- [開発環境のセットアップ](#開発環境のセットアップ)
  - [ローカル開発環境](#ローカル開発環境)
  - [開発用コマンド](#開発用コマンド)
- [プルリクエストの提出方法](#プルリクエストの提出方法)
- [コミットメッセージの規則](#コミットメッセージの規則)
- [質問やサポート](#質問やサポート)

## コード規約

コミット前に自動的にリンティングが実行されます（Huskyフック）。

### SQLファイル

SQLファイルは自動フォーマッターにより整形されます: `npm run sql:fix`

### Markdownドキュメント

Markdownドキュメントは`remark`と`textlint`によるリンティングが適用されます: `npm run docs:lint`

## Flyway

本リポジトリでは Flyway を用いてスキーマ管理を行います。

### Versioned Migration の命名フォーマット

マイグレーション・ファイルはソート順がそのまま実行順になるため、以下の命名ルールを厳守してください。

※ Versioned & Repeatable の区別はファイル名で判定されます。

`VYYYYMMDD_NNN__<説明>.sql`

| 要素         | 内容                               | 例                 |
| :--------- | :------------------------------- | :---------------- |
| `V`        | Versioned の識別子                   | -                 |
| `YYYYMMDD` | JST の日付 8 桁                      | `20250401`        |
| `NNN`      | 10 刻み 3 桁連番010 → 020 → 030 …     | `010`             |
| `<説明>`     | スネークケース英語。ddl\_ / dml\_ などを付けても可 | `ddl_init_schema` |

#### ルール

1. 昇順＝実行順 になるよう、必ず日付 + ゼロ埋め 3 桁で記述してください
2. 同日に複数ファイルを作る場合は 010, 020, 030… と 10 刻みで増やします
3. 差し込みが必要になったら未使用の番号（例: 015）を利用します

### Repeatable Migration の命名フォーマット

`R__<説明>.sql`

- 内容が変わったときにだけ再実行されるファイル。
- ビュー定義やストアドプロシージャ、モックデータ全上書きなどに使用します。

### マイグレーションの実行方法

マイグレーションは自動的に適用されます。新しいマイグレーションファイルを追加した場合:

1. `sql/migration/` ディレクトリに適切な命名規則でSQLファイルを配置
2. データベースを再起動するか、Flywayコマンドを実行

## 開発環境のセットアップ

### ローカル開発環境

#### 1. 必要なツールのインストール

```bash
# nodeモジュールのインストール
npm install

# Pythonの仮想環境設定（オプション）
python -m venv .venv
source .venv/bin/activate  # Windowsの場合: .venv\Scripts\activate
pip install -e .
```

#### 2. データベースの起動

```bash
docker compose up -d
```

### 開発用コマンド

```bash
# SQLファイルのフォーマット
npm run sql:fix

# Markdownドキュメントのリンティング
npm run docs:lint

# ドキュメントサイトの起動（MkDocs）
npm run docs:serve

# テーブル定義ドキュメントの生成
npm run tbls:doc
```

## プルリクエストの提出方法

1. 新しいブランチを作成します（`feature/xxxx` または `fix/xxxx`）
2. 変更を加えます
3. コミット前に必ずテストとリンティングを実行してください
4. プルリクエストを作成し、詳細な説明を記載してください

## コミットメッセージの規則

コミットメッセージは以下の形式で記述してください：

```text
<type>: <description>

[optional body]
```

typeには以下のいずれかを使用します

- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの意味に影響しない変更（空白、フォーマットなど）
- `refactor`: バグ修正でも機能追加でもないコード変更
- `test`: テストの追加・修正
- `chore`: ビルドプロセスやツールの変更

## 質問やサポート

質問やサポートが必要な場合は、Issueを作成するか、プロジェクトメンテナに直接連絡してください。
